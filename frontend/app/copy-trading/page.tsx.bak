'use client';

import { useState, useEffect } from 'react';
import { useAccount } from 'wagmi';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { Progress } from '@/components/ui/progress';
import { Separator } from '@/components/ui/separator';
import { Avatar, AvatarFallback } from '@/components/ui/avatar';
import { TrendingUp, TrendingDown, Users, Activity, Pause, Play, Trash2, DollarSign } from 'lucide-react';
import Link from 'next/link';

interface CopyFollow {
  id: string;
  trader: {
    wallet_address: string;
    username?: string;
    stats: {
      total_bets: number;
      wins: number;
      win_rate: number;
      total_score: number;
      total_volume: string;
    };
  };
  allocation_percentage: number;
  max_bet_amount: string;
  is_active: boolean;
  created_at: string;
  platform: {
    name: string;
  } | null;
}

interface CopyTrade {
  id: string;
  original_bet: {
    amount: string;
    position: string;
    market_id: string;
  };
  copied_bet: {
    amount: string;
    won: boolean | null;
    claimed_amount: string | null;
  };
  executed_at: string;
  trader_address: string;
}

export default function CopyTradingDashboard() {
  const { address, isConnected } = useAccount();
  const [activeFollows, setActiveFollows] = useState<CopyFollow[]>([]);
  const [copyTrades, setCopyTrades] = useState<CopyTrade[]>([]);
  const [loading, setLoading] = useState(true);
  const [stats, setStats] = useState({
    totalFollowing: 0,
    totalCopied: 0,
    totalProfit: '0',
    successRate: 0,
  });

  useEffect(() => {
    if (isConnected && address) {
      loadDashboardData();
    }
  }, [isConnected, address]);

  async function loadDashboardData() {
    setLoading(true);
    try {
      // Fetch active follows
      const followsRes = await fetch(`/api/copy-trade/follow?address=${address}`);
      if (followsRes.ok) {
        const followsData = await followsRes.json();
        setActiveFollows(followsData.follows || []);
      }

      // Fetch copy trade history
      const tradesRes = await fetch(`/api/copy-trade/history?address=${address}`);
      if (tradesRes.ok) {
        const tradesData = await tradesRes.json();
        setCopyTrades(tradesData.trades || []);
        setStats(tradesData.stats || stats);
      }
    } catch (error) {
      console.error('Error loading dashboard:', error);
    } finally {
      setLoading(false);
    }
  }

  async function toggleFollow(followId: string, currentState: boolean) {
    try {
      const res = await fetch('/api/copy-trade/follow', {
        method: 'PATCH',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ followId, isActive: !currentState }),
      });

      if (res.ok) {
        await loadDashboardData();
      }
    } catch (error) {
      console.error('Error toggling follow:', error);
    }
  }

  async function deleteFollow(followId: string) {
    try {
      const res = await fetch(`/api/copy-trade/follow?followId=${followId}`, {
        method: 'DELETE',
      });

      if (res.ok) {
        await loadDashboardData();
      }
    } catch (error) {
      console.error('Error deleting follow:', error);
    }
  }

  function formatBNB(wei: string): string {
    return (Number(wei) / 1e18).toFixed(4);
  }

  function shortenAddress(addr: string): string {
    return `${addr.slice(0, 6)}...${addr.slice(-4)}`;
  }

  if (!isConnected) {
    return (
      <div className="container mx-auto px-4 py-16 max-w-4xl">
        <Card>
          <CardContent className="flex flex-col items-center justify-center py-16">
            <Users className="h-16 w-16 text-muted-foreground mb-4" />
            <h2 className="text-2xl font-bold mb-2">Connect Your Wallet</h2>
            <p className="text-muted-foreground">
              Connect your wallet to view your copy trading dashboard
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="container mx-auto px-4 py-8 max-w-7xl">
      <div className="mb-8">
        <h1 className="text-4xl font-bold mb-2">Copy Trading Dashboard</h1>
        <p className="text-muted-foreground">
          Manage your copy trading follows and track performance
        </p>
      </div>

      {/* Stats Overview */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Following
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">{stats.totalFollowing}</div>
            <p className="text-xs text-muted-foreground mt-1">Active traders</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Total Copied
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">{stats.totalCopied}</div>
            <p className="text-xs text-muted-foreground mt-1">Bets executed</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Win Rate
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold">{stats.successRate.toFixed(1)}%</div>
            <p className="text-xs text-muted-foreground mt-1">Success rate</p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground">
              Total P/L
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-3xl font-bold flex items-center gap-2">
              {Number(stats.totalProfit) >= 0 ? (
                <TrendingUp className="h-6 w-6 text-green-500" />
              ) : (
                <TrendingDown className="h-6 w-6 text-red-500" />
              )}
              <span className={Number(stats.totalProfit) >= 0 ? 'text-green-500' : 'text-red-500'}>
                {formatBNB(stats.totalProfit)} BNB
              </span>
            </div>
          </CardContent>
        </Card>
      </div>

      <Tabs defaultValue="active" className="space-y-6">
        <TabsList>
          <TabsTrigger value="active">Active Follows ({activeFollows.length})</TabsTrigger>
          <TabsTrigger value="history">Trade History ({copyTrades.length})</TabsTrigger>
        </TabsList>

        <TabsContent value="active" className="space-y-4">
          {loading ? (
            <Card>
              <CardContent className="py-16 text-center">
                <Activity className="h-8 w-8 animate-spin mx-auto mb-4 text-muted-foreground" />
                <p className="text-muted-foreground">Loading follows...</p>
              </CardContent>
            </Card>
          ) : activeFollows.length === 0 ? (
            <Card>
              <CardContent className="py-16 text-center">
                <Users className="h-16 w-16 text-muted-foreground mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Active Follows</h3>
                <p className="text-muted-foreground mb-4">
                  Start following top traders from the leaderboard
                </p>
                <Link href="/leaderboard">
                  <Button>Browse Leaderboard</Button>
                </Link>
              </CardContent>
            </Card>
          ) : (
            activeFollows.map((follow) => (
              <Card key={follow.id}>
                <CardHeader>
                  <div className="flex items-start justify-between">
                    <div className="flex items-center gap-4">
                      <Avatar className="h-12 w-12">
                        <AvatarFallback>
                          {follow.trader.username?.[0]?.toUpperCase() ||
                            follow.trader.wallet_address.slice(2, 4).toUpperCase()}
                        </AvatarFallback>
                      </Avatar>
                      <div>
                        <CardTitle className="text-lg">
                          {follow.trader.username || shortenAddress(follow.trader.wallet_address)}
                        </CardTitle>
                        <CardDescription className="font-mono text-xs">
                          {shortenAddress(follow.trader.wallet_address)}
                        </CardDescription>
                      </div>
                    </div>
                    <div className="flex gap-2">
                      <Button
                        variant={follow.is_active ? 'outline' : 'default'}
                        size="sm"
                        onClick={() => toggleFollow(follow.id, follow.is_active)}
                      >
                        {follow.is_active ? (
                          <>
                            <Pause className="h-4 w-4 mr-2" />
                            Pause
                          </>
                        ) : (
                          <>
                            <Play className="h-4 w-4 mr-2" />
                            Resume
                          </>
                        )}
                      </Button>
                      <Button
                        variant="destructive"
                        size="sm"
                        onClick={() => deleteFollow(follow.id)}
                      >
                        <Trash2 className="h-4 w-4" />
                      </Button>
                    </div>
                  </div>
                </CardHeader>
                <CardContent className="space-y-4">
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                      <p className="text-sm text-muted-foreground">Win Rate</p>
                      <p className="text-xl font-bold">{(follow.trader?.stats?.win_rate || 0).toFixed(1)}%</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Total Bets</p>
                      <p className="text-xl font-bold">{follow.trader?.stats?.total_bets || 0}</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Score</p>
                      <p className="text-xl font-bold">{follow.trader?.stats?.total_score || 0}</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground">Volume</p>
                      <p className="text-xl font-bold">{formatBNB(follow.trader?.stats?.total_volume || '0')} BNB</p>
                    </div>
                  </div>

                  <Separator />

                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                      <p className="text-sm text-muted-foreground mb-2">Allocation</p>
                      <Progress value={follow.allocation_percentage} className="h-2 mb-1" />
                      <p className="text-sm font-medium">{follow.allocation_percentage}%</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-2">Max Bet</p>
                      <p className="text-sm font-medium">{formatBNB(follow.max_bet_amount)} BNB</p>
                    </div>
                    <div>
                      <p className="text-sm text-muted-foreground mb-2">Platform</p>
                      <Badge variant="secondary">
                        {follow.platform?.name || 'All Platforms'}
                      </Badge>
                    </div>
                  </div>

                  <div className="flex items-center gap-2">
                    <Badge variant={follow.is_active ? 'default' : 'secondary'}>
                      {follow.is_active ? 'Active' : 'Paused'}
                    </Badge>
                    <span className="text-xs text-muted-foreground">
                      Following since {new Date(follow.created_at).toLocaleDateString()}
                    </span>
                  </div>
                </CardContent>
              </Card>
            ))
          )}
        </TabsContent>

        <TabsContent value="history" className="space-y-4">
          {copyTrades.length === 0 ? (
            <Card>
              <CardContent className="py-16 text-center">
                <Activity className="h-16 w-16 text-muted-foreground mx-auto mb-4" />
                <h3 className="text-xl font-semibold mb-2">No Copy Trades Yet</h3>
                <p className="text-muted-foreground">
                  Your copy trades will appear here once traders you follow place bets
                </p>
              </CardContent>
            </Card>
          ) : (
            <Card>
              <CardHeader>
                <CardTitle>Recent Copy Trades</CardTitle>
                <CardDescription>History of automatically copied bets</CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-4">
                  {copyTrades.map((trade) => (
                    <div
                      key={trade.id}
                      className="flex items-center justify-between p-4 border rounded-lg"
                    >
                      <div className="flex-1">
                        <div className="flex items-center gap-2 mb-1">
                          <Badge variant="outline">{trade.original_bet.position}</Badge>
                          <span className="text-sm text-muted-foreground">
                            Market #{trade.original_bet.market_id}
                          </span>
                        </div>
                        <p className="text-sm text-muted-foreground">
                          From {shortenAddress(trade.trader_address)}
                        </p>
                        <p className="text-xs text-muted-foreground mt-1">
                          {new Date(trade.executed_at).toLocaleString()}
                        </p>
                      </div>
                      <div className="text-right">
                        <p className="text-sm font-medium">
                          {formatBNB(trade.copied_bet.amount)} BNB
                        </p>
                        {trade.copied_bet.won !== null && (
                          <Badge
                            variant={trade.copied_bet.won ? 'default' : 'destructive'}
                            className="mt-1"
                          >
                            {trade.copied_bet.won ? 'Won' : 'Lost'}
                          </Badge>
                        )}
                        {trade.copied_bet.won === null && (
                          <Badge variant="secondary" className="mt-1">
                            Pending
                          </Badge>
                        )}
                      </div>
                    </div>
                  ))}
                </div>
              </CardContent>
            </Card>
          )}
        </TabsContent>
      </Tabs>
    </div>
  );
}
